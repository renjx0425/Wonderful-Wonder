const scenes = {
  1: {
    title: "Scene 1 - Lunchroom",
    perspectives: {
      august: "As August stepped into the lunchroom, the sound hit him first—a roaring cacophony of clanging trays, overlapping conversations, and laughter that seemed to echo off the walls. His heart started pounding, the way it always did when he entered a crowded space. It wasn’t just the noise; it was the stares. Even though he tried to avoid looking directly at anyone, he could feel their eyes on him, flickering glances that they thought he wouldn’t notice.\n\n" +
        "He gripped his lunch bag so tightly that his knuckles turned white, holding onto it like it was a lifeline. The air felt thick, heavy with tension, as he scanned the room. Groups of kids were clustered at tables, their voices blending into a buzz that felt like static in his ears. His eyes darted from one table to another, hoping to find a place where he wouldn’t feel completely out of place, but he only saw backs turned toward him or glances that quickly looked away.\n\n" +
        "The lunchroom seemed impossibly big, but at the same time, it felt like there wasn’t enough space for him. He thought about going back to the classroom to eat by himself, but then he remembered Mr. Tushman’s voice in his head: “You can’t always hide, August. Sometimes, you have to put yourself out there.” Easier said than done, he thought bitterly.\n\n" +
        "As he stood frozen, the noises around him seemed to grow louder. Laughter erupted from a table nearby, and his face burned, certain they were laughing at him. He looked down at his sneakers, willing himself to disappear. But he couldn’t just stand there forever. Taking a shaky breath, he forced himself to move. His legs felt like lead as he walked, scanning for a table where he could sit without feeling like he was on display.\n\n" +
        "There was an empty table near the corner, but the thought of sitting there alone, with everyone staring at him, made his stomach churn. He thought about Jack and whether he should try sitting with him, but Jack was surrounded by other kids, all laughing and talking loudly. August knew he wouldn’t fit in there. He wasn’t sure he fit in anywhere.\n\n" +
        "Finally, he spotted a table near the edge of the room with only one other person sitting at it. It was Summer. She was busy unwrapping her sandwich, not talking to anyone, just... sitting. She didn’t look up as he approached, and for a moment, he hesitated. What if she didn’t want him to sit there? What if she said something like, “Sorry, this seat is taken,” or worse, didn’t say anything at all and just looked at him with pity?\n\n" +
        "But then she looked up, and their eyes met. She smiled. Not a big, fake smile like some of the teachers gave him, but a small, warm smile that made his heart stop pounding so much.\n\n" +
        "“Hey,” she said, her voice light and casual. “Want to sit here?”\n\n" +
        "He blinked, unsure if he’d heard her right. He looked over his shoulder, expecting to see someone else she was talking to, but there was no one there. Slowly, he nodded. “Sure,” he mumbled, his voice barely audible.\n\n" +
        "As he sat down, he felt the weight of the stares lift just a little. They were still there—he could feel them—but somehow they didn’t seem as heavy with Summer sitting across from him. She started talking about how weird the spaghetti looked today, and even though he wasn’t sure what to say, he felt his lips twitch into the smallest of smiles.\n\n" +
        "For the first time in what felt like forever, August didn’t feel completely invisible.",
      via: "From her seat across the lunchroom, Via watches her brother hover near the entrance. She notices the slight tremble in his hands and the way his eyes dart around the room. Her protective instincts flare up, and she feels an urge to rush over and stand by his side. But she hesitates, knowing that August wants to be treated like everyone else. She wrestles with conflicting emotions—pride in his bravery and fear for his vulnerability. She silently wills someone to reach out to him, her own lunch forgotten as she watches the scene unfold.",
      jack: "Jack spots August lingering by the doorway, looking like a deer caught in headlights. He remembers the time they were science partners and how easy it was to talk to him. Jack glances at his usual table where his friends are goofing off, then back at August. A pang of guilt twists in his stomach. He knows what the right thing to do is. 'Hey, guys, I'll catch up with you later,' he says to his friends, who raise their eyebrows in surprise. He strides over to August, offering a casual smile. 'Mind if I sit with you?' he asks, hoping to make this first step a little easier for both of them.",
      summer: "Summer entered the lunchroom, the familiar din of clanging trays and overlapping conversations greeting her as usual. She carried her tray carefully, balancing her juice box and sandwich, her eyes casually scanning the room. Her table was where it always was, surrounded by her usual friends who were already deep in a lively debate over some YouTube video they’d all seen.\n\n" +
        "She started walking toward them, but something stopped her. Out of the corner of her eye, she noticed August standing at the edge of the room, gripping his lunch bag so tightly it looked like it might rip. He wasn’t moving, just staring out at the crowded tables as though he were staring into a battlefield. Her friends waved her over, but she hesitated. August’s eyes darted around the room, searching for something—or someone—but finding nothing. His shoulders slumped just slightly, the smallest movement, but it was enough.\n\n" +
        "Summer remembered the first time she’d walked into this lunchroom. She hadn’t known where to sit either. It was just after her dad died, and she’d transferred schools. Nobody had pointed or whispered, but she’d felt the weight of their stares. She’d felt like an alien dropped into a world that didn’t belong to her. That was why, when she saw August now, standing like a lost balloon caught in a corner, she couldn’t just walk away.\n\n" +
        "Her friends’ laughter floated toward her. She knew they wouldn’t understand—not really. But that didn’t matter. Taking a deep breath, she turned on her heel and made her way to August. The closer she got, the more she could see the tension in his face. His eyes darted toward her, then quickly back to the floor.\n\n" +
        "“Hey,” she said, setting her tray down on the empty spot across from him. He looked up at her, startled. For a moment, she thought he might tell her to go away. His face seemed to tighten, almost like he was bracing himself for some kind of insult. She kept her voice light. “Mind if I sit here?”\n\n" +
        "His eyebrows shot up. “You want to sit here?” His voice was quiet, barely audible over the clatter of the lunchroom.\n\n" +
        "“Yeah, why not?” She smiled, pulling out the chair. She could feel the eyes of her friends burning into her back, but she ignored them. “It’s better than sitting by myself, don’t you think?” she added, though they both knew it wasn’t true.\n\n" +
        "For a moment, he didn’t say anything. Then, slowly, he nodded. “Sure,” he mumbled, and she could hear the hesitation in his voice. But he didn’t tell her to leave, and that was enough for her.\n\n" +
        "She started unwrapping her sandwich, talking casually about how the school lunch spaghetti was suspiciously orange today and how she was pretty sure the juice boxes were just flavored water. At first, August didn’t say much. He kept looking at her, as if trying to figure out why she was there. But little by little, he started to relax. His grip on the lunch bag loosened, and he even laughed softly when she made a joke about how the spaghetti might actually be lasagna in disguise.\n\n" +
        "Summer didn’t care that her friends would probably ask her about this later. She didn’t care that some kids were probably whispering behind her back. What mattered was the look on August’s face—a look that said, for the first time that day, he didn’t feel invisible.\n\n" +
        "As they chatted about their favorite movies and how science class smelled like vinegar, Summer decided that this was her new favorite spot in the lunchroom. And as August finally smiled, she realized something else: maybe he needed her to sit here today, but she needed it, too.",
      julian: "Julian leans back in his chair, casually tossing a grape into his mouth as he notices August standing alone. A sly grin spreads across his face. 'Check it out,' he whispers to his entourage, nodding in August's direction. 'Looks like someone forgot to tell him it's not Halloween yet.' His friends snicker, and Julian feels a surge of satisfaction. Making others laugh is his specialty, even if it means someone else gets hurt. To him, it's all in good fun—a harmless joke that keeps him at the center of attention."
    },
    reflection: "How do you think August feels when someone finally sits with him?"
  },
  2: {
    title: "Scene 2 - Classroom",
    perspectives: {
      august: "August feels nervous in the classroom...",
      via: "Via is concerned about August’s first day...",
      jack: "Jack tries to include August in the conversation...",
      summer: "Summer encourages others to include August...",
      julian: "Julian avoids interacting with August."
    },
    reflection: "What could you do to help someone feel included?"
  },
  3: {
    title: "Scene 3 - Playground",
    perspectives: {
      august: "August tries to fit in while others are playing...",
      via: "Via watches August from a distance, worried about him...",
      jack: "Jack invites August to join the game to make him feel welcome...",
      summer: "Summer makes sure August isn’t left out...",
      julian: "Julian avoids August and whispers about him to others."
    },
    reflection: "Why is it important to make others feel welcome in a new environment?"
  }
};

// Display selected scene and character perspective
function showScene(sceneNumber) {
  const character1 = 'august'; // Fix Auggie as the main perspective
  const character2 = 'summer'; // Fix Summer as the comparative perspective

  const scene = scenes[sceneNumber];
  if (scene && scene.perspectives[character1] && scene.perspectives[character2]) {
    document.getElementById('scene-title').textContent = scene.title;
    document.getElementById('scene-description').textContent = "View Auggie and Summer's perspectives below.";
    document.getElementById('reflection-question').textContent = scene.reflection;

    showParallelPassages(sceneNumber, character1, character2);
  }
}

// Character image paths
const characterImages = {
august: "images/auggie_icon.png",
via: "images/via_icon.png",
jack: "images/jack_icon.png",
summer: "images/summer_icon.png",
julian: "images/julian_icon.png"
};

// Update character icon
function updateCharacterImage() {
const character = document.getElementById('character-select').value;
const iconPath = characterImages[character];
document.getElementById('character-icon').src = iconPath;
}

// Initialize with the first character's image
document.addEventListener("DOMContentLoaded", () => {
updateCharacterImage();
});

// Save reflection response to LocalStorage
function saveReflection() {
const sceneNumber = document.getElementById('scene-title').textContent;
const response = document.getElementById('reflection-response').value;
localStorage.setItem(`reflection_${sceneNumber}`, response);

const saveConfirmation = document.getElementById('save-confirmation');
saveConfirmation.style.display = "inline";
setTimeout(() => {
  saveConfirmation.style.display = "none";
}, 2000);
}

// Load reflection response from LocalStorage
function loadReflection(sceneNumber) {
const savedResponse = localStorage.getItem(`reflection_${sceneNumber}`);
document.getElementById('reflection-response').value = savedResponse || "";
}

// Draw Your Own Auggie - Canvas Drawing Functionality
const canvas = document.getElementById('drawing-canvas');
const ctx = canvas.getContext('2d');
let drawing = false;
let currentColor = document.getElementById('color-picker').value;

// Update color when color picker changes
document.getElementById('color-picker').addEventListener('input', function() {
  currentColor = this.value;
});

// Start drawing when mouse is pressed
canvas.addEventListener('mousedown', function(e) {
  drawing = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
});

// Draw line when mouse moves
canvas.addEventListener('mousemove', function(e) {
  if (drawing) {
    ctx.strokeStyle = currentColor;
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
  }
});

// Stop drawing when mouse is released
canvas.addEventListener('mouseup', function() {
  drawing = false;
  ctx.closePath();
});

// Clear the canvas
function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

// Badge Tracking Variables
let perspectivesViewed = new Set();
let reflectionCompleted = false;
let drawingCompleted = false;

// Award badges with animation and tooltip update
function awardBadge(badgeId) {
  const badge = document.getElementById(badgeId);
  badge.style.opacity = "1";
  badge.setAttribute("data-achieved", "true");
  badge.classList.add("achieved-badge-animation"); // Add animation class
  localStorage.setItem(badgeId, "true");

  // Show notification or celebrate
  celebrateAchievement(badgeId);
}

// Tooltip display for badge descriptions
document.querySelectorAll('.badge').forEach(badge => {
  badge.addEventListener('mouseenter', () => {
    const description = badge.getAttribute('data-achievement');
    document.getElementById('badge-description').textContent = description;
  });
  badge.addEventListener('mouseleave', () => {
    document.getElementById('badge-description').textContent = "Hover over a badge to see its requirements.";
  });
});

// Celebration for unlocking an achievement
function celebrateAchievement(badgeId) {
  const badge = document.getElementById(badgeId);
  badge.classList.add("celebrate");
  setTimeout(() => badge.classList.remove("celebrate"), 1500);
}

// Check if the Perspective Explorer badge should be awarded
function checkPerspectiveExplorer(sceneNumber, character) {
  perspectivesViewed.add(`${sceneNumber}-${character}`);
  const totalCharacters = Object.keys(scenes[sceneNumber].perspectives).length;
  if (perspectivesViewed.size === totalCharacters) {
    awardBadge("perspective-explorer-badge");
  }
}

// Check if the Reflection Master badge should be awarded
function checkReflectionMaster() {
  reflectionCompleted = true;
  awardBadge("reflection-master-badge");
}

// Check if the Creative Artist badge should be awarded
function checkCreativeArtist() {
  if (!drawingCompleted) {
    drawingCompleted = true;
    awardBadge("creative-artist-badge");
  }
}

// Load awarded badges from LocalStorage on page load
function loadAwardedBadges() {
  if (localStorage.getItem("perspective-explorer-badge")) {
    awardBadge("perspective-explorer-badge");
  }
  if (localStorage.getItem("reflection-master-badge")) {
    awardBadge("reflection-master-badge");
  }
  if (localStorage.getItem("creative-artist-badge")) {
    awardBadge("creative-artist-badge");
  }
}

// Initialize with the first character's image and load awarded badges
document.addEventListener("DOMContentLoaded", () => {
  updateCharacterImage();
  loadAwardedBadges();
});

// Update showScene function to track perspectives viewed
function showScene(sceneNumber) {
  const character1 = document.getElementById('character-select').value;
  
  // Set default second character for comparison (e.g., Summer)
  const character2 = character1 === 'august' ? 'summer' : 'august';

  const scene = scenes[sceneNumber];

  if (scene && scene.perspectives[character1]) {
    // Update main scene content
    document.getElementById('scene-title').textContent = scene.title;
    document.getElementById('scene-description').textContent = scene.perspectives[character1];
    document.getElementById('reflection-question').textContent = scene.reflection;
    loadReflection(scene.title);

    // Update scene image for selected character
    const sceneImage = document.getElementById('scene-image');
    if (sceneNumber === 1 && character1 === 'august') {
      sceneImage.src = "images/auggie_lunchroom.gif";
      sceneImage.style.display = "block";
    } else {
      sceneImage.style.display = "none";
    }

    // Update Parallel Perspectives section
    showParallelPassages(sceneNumber, character1, character2);
  }
}

// Update saveReflection to award Reflection Master badge
function saveReflection() {
  const sceneNumber = document.getElementById('scene-title').textContent;
  const response = document.getElementById('reflection-response').value;
  localStorage.setItem(`reflection_${sceneNumber}`, response);

  const saveConfirmation = document.getElementById('save-confirmation');
  saveConfirmation.style.display = "inline";
  setTimeout(() => {
    saveConfirmation.style.display = "none";
  }, 2000);

  // Award Reflection Master badge if the reflection is completed
  checkReflectionMaster();
}

// Update canvas drawing events to award Creative Artist badge
canvas.addEventListener('mousedown', function() {
  drawing = true;
  checkCreativeArtist(); // Award badge when starting to draw
  ctx.beginPath();
  ctx.moveTo(event.offsetX, event.offsetY);
});


function showParallelPassages(sceneNumber, character1, character2) {
  const scene = scenes[sceneNumber];
  
  if (scene) {
    const perspective1 = scene.perspectives[character1];
    const perspective2 = scene.perspectives[character2];

    // Update the left passage
    document.getElementById('left-title').textContent = `${character1.charAt(0).toUpperCase() + character1.slice(1)}'s Perspective`;
    document.getElementById('left-text').textContent = perspective1;

    // Update the right passage
    document.getElementById('right-title').textContent = `${character2.charAt(0).toUpperCase() + character2.slice(1)}'s Perspective`;
    document.getElementById('right-text').textContent = perspective2;

    // Highlight differences (simple keyword comparison)
    highlightDifferences('left-text', 'right-text');
  }
}

// function highlightDifferences(leftId, rightId) {
//   const leftText = document.getElementById(leftId);
//   const rightText = document.getElementById(rightId);

//   const leftWords = leftText.textContent.split(' ');
//   const rightWords = rightText.textContent.split(' ');

//   const highlightedLeft = leftWords.map(word => rightWords.includes(word) ? word : `<mark>${word}</mark>`).join(' ');
//   const highlightedRight = rightWords.map(word => leftWords.includes(word) ? word : `<mark>${word}</mark>`).join(' ');

//   leftText.innerHTML = highlightedLeft;
//   rightText.innerHTML = highlightedRight;
// }
// Define key words or phrases that represent important differences
const keyDifferenceMarkers = ['nervous', 'laughing', 'stares', 'lonely', 'empathy', 'isolated', 'comfort'];

function highlightDifferences(leftId, rightId) {
  const leftText = document.getElementById(leftId);
  const rightText = document.getElementById(rightId);

  const leftWords = leftText.textContent.split(' ');
  const rightWords = rightText.textContent.split(' ');

  // Highlight only the key difference markers
  const highlightedLeft = leftWords.map(word => 
    keyDifferenceMarkers.includes(word.toLowerCase()) 
      ? `<mark data-tooltip="Auggie's unique perspective: Feeling nervous">${word}</mark>`
      : word).join(' ');

  const highlightedRight = rightWords.map(word => 
    keyDifferenceMarkers.includes(word.toLowerCase()) 
      ? `<mark data-tooltip="Summer's unique perspective: Feeling empathetic">${word}</mark>`
      : word).join(' ');

  leftText.innerHTML = highlightedLeft;
  rightText.innerHTML = highlightedRight;

  // Enable tooltip functionality
  enableTooltips();
}


function enableTooltips() {
  document.querySelectorAll('mark').forEach(mark => {
    mark.addEventListener('mouseenter', (e) => {
      const tooltip = document.createElement('div');
      tooltip.className = 'tooltip';
      tooltip.textContent = e.target.getAttribute('data-tooltip');
      document.body.appendChild(tooltip);
      tooltip.style.left = `${e.pageX + 5}px`;
      tooltip.style.top = `${e.pageY + 5}px`;
    });

    mark.addEventListener('mouseleave', () => {
      document.querySelectorAll('.tooltip').forEach(tooltip => tooltip.remove());
    });
  });
}

// Allow the dragged item to be dropped
function allowDrop(ev) {
  ev.preventDefault();
}

// Store the ID of the dragged element
function drag(ev) {
  ev.dataTransfer.setData("text", ev.target.id);
}

// Handle the drop event and append the item to the correct category
function drop(ev) {
  ev.preventDefault();
  var data = ev.dataTransfer.getData("text");
  var draggedElement = document.getElementById(data);
  var dropZone = ev.target;

  // Prevent dropping the item outside the drop zone
  if (dropZone.classList.contains('drop-zone')) {
    dropZone.appendChild(draggedElement);  // Append the dragged item
    draggedElement.style.backgroundColor = '#dcdcdc'; // Change color to show it's been dropped
  }
}

